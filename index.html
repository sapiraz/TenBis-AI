<!DOCTYPE html>
<html>
<head>
</head>
<body>

<style>

    body {
        background: #ce2222;
    }

    .video-wrap {
        text-align: center;
    }

    .titles {
        color: white;
        font-size: 30px;
    }

    .main-title {
        font-size: 50px;
    }

    .logo {
        width: 20%;
        text-align: center;
    }

    #canvas {
        width: 1px !important;
        height: 1px !important;
    }
    .flash {
        width: 100%;
        height: 100vh;
        opacity: 0;
        background: white;
        z-index: 5;
        position: absolute;
        top: 0;
        left: 0;
        transition: .3s opacity;
    }

    .disable {
        opacity: 0;
        transition: .2s opacity;
    }

    .lds-ellipsis {
        display: inline-block;
        position: relative;
        width: 64px;
        height: 64px;
    }
    .lds-ellipsis div {
        position: absolute;
        top: 27px;
        width: 11px;
        height: 11px;
        border-radius: 50%;
        background: #fff;
        animation-timing-function: cubic-bezier(0, 1, 1, 0);
    }
    .lds-ellipsis div:nth-child(1) {
        left: 6px;
        animation: lds-ellipsis1 0.6s infinite;
    }
    .lds-ellipsis div:nth-child(2) {
        left: 6px;
        animation: lds-ellipsis2 0.6s infinite;
    }
    .lds-ellipsis div:nth-child(3) {
        left: 26px;
        animation: lds-ellipsis2 0.6s infinite;
    }
    .lds-ellipsis div:nth-child(4) {
        left: 45px;
        animation: lds-ellipsis3 0.6s infinite;
    }
    @keyframes lds-ellipsis1 {
        0% {
            transform: scale(0);
        }
        100% {
            transform: scale(1);
        }
    }
    @keyframes lds-ellipsis3 {
        0% {
            transform: scale(1);
        }
        100% {
            transform: scale(0);
        }
    }
    @keyframes lds-ellipsis2 {
        0% {
            transform: translate(0, 0);
        }
        100% {
            transform: translate(19px, 0);
        }
    }

    #logo {
        display: block;
        margin: auto;
        margin-top: 20px;
    }
    .tenbis-logo {
        margin-top: 20px;
        margin-bottom: 20px;
    }
    #logos_wrapper img {
        margin: 0 2%;
    }
    #logos_wrapper {
        display: flex;
        flex-direction: row;
        justify-content: center;
    }

</style>

<div id="flash" class="flash"></div>
<!-- Stream video via webcam -->
<div class="video-wrap">
    <div class="tenbis-logo">
        <svg class="logo" height="100%" viewBox="0 0 205 61" version="1.1" xmlns="http://www.w3.org/2000/svg"
             xmlns:xlink="http://www.w3.org/1999/xlink">
            <!-- Generator: Sketch 52.5 (67469) - http://www.bohemiancoding.com/sketch -->
            <title>elements/logo/long/205x61/white</title>
            <desc>Created with Sketch.</desc>
            <g id="elements/logo/long/205x61/white" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                <g id="Group-3" fill="#FFFFFF">
                    <path d="M172.508626,0.588593017 C173.690687,-0.196331006 175.229559,-0.196331006 176.41162,0.588593017 C179.414614,2.47241067 182.297009,4.54003964 185.040865,6.78154419 C185.040865,6.78154419 185.786381,7.29919662 185.809305,6.42187015 C185.809305,6.42187015 185.68472,3.83758232 186.000667,3.04371613 C186.210966,2.42769981 186.78904,2.011392 187.440868,2.0074177 C187.440868,2.0074177 190.830573,2.17632541 192.981405,2.4634685 C193.944197,2.61151113 194.677753,3.39941588 194.754497,4.36616407 C194.754497,4.36616407 196.138884,13.5716338 196.449848,16.8871926 C196.449848,16.8871926 196.719948,18.5762696 199.171777,21.4367712 C199.171777,21.4367712 204.119291,28.3619869 204.728262,29.7241779 C204.728262,29.7241779 205.892383,32.1335965 203.401682,32.4545212 C203.401682,32.4545212 198.84985,32.910572 198.420282,33.017878 C197.799351,33.0755054 197.341875,33.6239586 197.400679,34.2429556 C197.401676,34.2548785 197.402673,34.2668014 197.404666,34.2787243 C197.404666,34.2787243 197.16646,50.2792515 195.992372,57.9695198 C195.992372,57.9695198 195.687388,61.0217813 193.987054,60.9432889 C193.987054,60.9432889 189.315621,60.7902784 188.231234,60.8240599 C188.231234,60.8240599 187.757812,60.858835 187.830569,60.200095 C187.830569,60.200095 190.208645,35.2414982 188.594025,22.6191251 C188.594025,22.6191251 188.531235,20.9916497 187.277413,20.6538343 C187.277413,20.6538343 186.148176,20.1977835 185.057809,21.6901327 C185.057809,21.6901327 177.653482,31.0645101 177.665442,44.2104972 C177.665442,44.2104972 177.529894,48.2016868 178.138865,49.2210944 C178.138865,49.2210944 178.517603,49.9185839 180.450163,50.0765622 L182.900996,50.4034483 C182.900996,50.4034483 183.358472,50.4034483 183.318605,50.9995932 C183.318605,50.9995932 182.753488,58.3192581 182.596012,59.6198474 C182.586046,59.9169262 182.525248,60.2100307 182.414617,60.4872381 C182.414617,60.4872381 182.324916,60.7346382 181.556476,60.7058245 C181.556476,60.7058245 170.758458,60.6273321 169.543507,60.7058245 C169.543507,60.7058245 169.036197,60.7574904 168.922576,60.4415336 C168.809951,60.1265705 168.17108,50.9886638 168.194004,49.6880745 C168.178057,49.4178222 168.328555,49.1644607 168.572742,49.0462253 C170.246165,48.0009847 171.351482,46.2512996 171.571748,44.294951 C171.571748,44.294951 171.72424,43.5348663 171.633542,40.10604 C171.633542,40.10604 172.029224,26.0648422 172.130885,23.8124083 C172.130885,23.8124083 172.215603,23.0523237 171.215934,22.9062682 C170.717595,22.7890264 170.219255,23.0970345 170.101647,23.5938219 C170.095667,23.621642 170.089687,23.6494621 170.0857,23.6772822 C170.0857,23.6772822 169.386032,32.9393856 169.52158,36.6265414 C169.52158,36.6265414 169.75879,39.0250307 168.098323,39.0697416 C168.098323,39.0697416 166.476726,39.3121738 166.403969,37.319063 C166.403969,37.319063 166.522573,28.3113146 166.918255,23.8630806 C166.928222,23.3563575 166.53852,22.9311076 166.031211,22.8953389 C165.498984,22.8098914 164.997655,23.1705591 164.910944,23.7021215 C164.906957,23.7299416 164.903967,23.7567681 164.900977,23.7845882 C164.900977,23.7845882 164.207289,32.398881 164.336857,36.947466 C164.336857,36.947466 164.540179,39.1541954 162.772071,39.0697416 C162.772071,39.0697416 161.29898,39.2446107 161.214262,37.2852814 C161.214262,37.2852814 161.61991,24.9550192 161.722568,23.9982068 C161.794329,23.4527343 161.408615,22.9519726 160.860441,22.8804352 C160.828547,22.8764609 160.79466,22.8734802 160.76177,22.8724866 C160.238514,22.80393 159.760108,23.1705591 159.691337,23.6911922 C159.68735,23.721993 159.68436,23.7527938 159.683364,23.7845882 C159.683364,23.7845882 159.022566,38.5302305 159.118247,42.8592355 C159.118247,42.8592355 159.056453,47.3124374 162.354463,49.1197498 C162.354463,49.1197498 162.840842,49.4009314 162.851805,49.8232007 C162.851805,49.8232007 163.224563,57.6495887 163.558451,60.1712813 C163.558451,60.1712813 163.682039,60.7733876 163.139846,60.7733876 L154.842495,60.9989291 C154.842495,60.9989291 153.466081,61.0943122 153.149137,59.3943059 C152.878041,57.812535 151.358106,44.7569632 151.607275,34.4029212 C151.672059,33.7580912 151.233521,33.169895 150.596643,33.0456981 C150.596643,33.0456981 146.348798,32.6522425 145.321222,32.398881 C144.378364,32.1554552 143.813247,31.1976492 144.056437,30.2577275 C144.097301,30.1007427 144.160091,29.9487257 144.242816,29.8086317 C144.242816,29.8086317 153.437178,12.3723891 172.508626,0.588593017"
                          id="Icon"></path>
                    <g id="Wording" transform="translate(0.000000, 19.000000)">
                        <path d="M70.7238,24.5533 L68.9578,24.5533 L68.9578,13.4733 C68.9578,4.6573 64.4548,1.1583 55.5728,1.1583 L47.4508,1.1583 C46.7388,1.1583 46.1618,1.7353 46.1618,2.4473 L46.1618,7.3403 C46.1618,8.0343 46.7238,8.5963 47.4178,8.5963 L54.6078,8.5963 C58.7958,8.5963 60.5048,10.2023 60.5048,14.1393 L60.5048,24.5533 L46.9808,24.5533 C45.8628,24.5533 44.9558,25.4593 44.9558,26.5773 L44.9558,29.9743 C44.9558,31.0883 45.8598,31.9913 46.9738,31.9913 L70.4538,31.9913 C71.7018,31.9913 72.7118,30.9803 72.7118,29.7333 L72.7118,26.5413 C72.7118,25.4433 71.8228,24.5533 70.7238,24.5533"
                              id="Fill-4"></path>
                        <path d="M117.9035,1.1583 L99.3035,1.1583 C99.0045,1.1583 98.7595,1.4023 98.7595,1.7023 L98.7595,8.0123 C98.7595,8.3353 99.0215,8.5963 99.3435,8.5963 L102.6675,8.5963 L102.6675,23.0193 C102.6675,25.0103 101.6675,25.0103 101.1855,25.0103 L98.9435,25.0153 C98.6185,25.0153 98.3545,25.2803 98.3545,25.6053 L98.3545,30.4423 C98.3545,31.5503 99.2535,32.4493 100.3615,32.4493 L101.5915,32.4493 C107.6465,32.4493 111.1205,29.0313 111.1205,23.0713 L111.1205,8.5963 L116.9395,8.5963 C121.1295,8.5963 121.3425,12.4743 121.3425,16.4483 L121.3425,30.0333 C121.3425,31.1143 122.2195,31.9913 123.3005,31.9913 L127.8375,31.9913 C128.9195,31.9913 129.7965,31.1143 129.7965,30.0333 L129.7965,13.7273 C129.7965,4.9103 126.7865,1.1583 117.9035,1.1583"
                              id="Fill-6"></path>
                        <path d="M36.1779,1.1583 C36.1049,1.1583 36.0349,1.1713 35.9649,1.1793 C35.9629,1.1763 35.9589,1.1583 35.9589,1.1583 L32.1949,1.1583 C31.8319,1.1583 31.5369,1.4523 31.5369,1.8153 L31.5369,7.9393 C31.5369,8.3023 31.8319,8.5963 32.1949,8.5963 L34.3379,8.5963 L34.3379,16.5903 C34.3379,17.7063 35.2429,18.6123 36.3599,18.6123 L40.7689,18.6123 C41.8859,18.6123 42.7909,17.7063 42.7909,16.5903 L42.7909,7.7713 C42.7909,4.1193 39.8299,1.1583 36.1779,1.1583"
                              id="Fill-8"></path>
                        <path d="M88.6271,1.1583 C88.5921,1.1583 88.5591,1.1673 88.5231,1.1683 C88.5051,1.1673 88.4891,1.1583 88.4711,1.1583 L83.2651,1.1583 C82.8991,1.1583 82.6031,1.4543 82.6031,1.8213 L82.6031,7.9863 C82.6031,8.3233 82.8761,8.5963 83.2131,8.5963 L86.5001,8.5963 L86.5001,39.2583 C86.5001,40.4293 87.4501,41.3803 88.6211,41.3803 L92.8061,41.3803 C93.9911,41.3803 94.9531,40.4183 94.9531,39.2323 L94.9531,7.4843 C94.9531,3.9903 92.1211,1.1583 88.6271,1.1583"
                              id="Fill-10"></path>
                        <path d="M21.5431,18.3986 C21.5431,22.1856 18.4731,25.2546 14.6861,25.2546 C10.8991,25.2546 7.8291,22.1856 7.8291,18.3986 L7.8291,7.8946 L13.9871,7.8946 C18.1601,7.8946 21.5431,11.2776 21.5431,15.4506 L21.5431,18.3986 Z M13.9871,0.5496 L2.3581,0.5496 C1.0561,0.5496 0.0001,1.6056 0.0001,2.9086 L0.0001,17.9146 C0.0001,26.0246 6.5751,32.6006 14.6861,32.6006 C22.7971,32.6006 29.3721,26.0246 29.3721,17.9146 L29.3721,15.9346 C29.3721,7.4376 22.4841,0.5496 13.9871,0.5496 Z"
                              id="Fill-12"></path>
                    </g>
                </g>
            </g>
        </svg>
    </div>

    <video id="video" playsinline autoplay></video>
    <div id="logos_wrapper"></div>
    <img id="logo" src="">
    <div id="loader" class="lds-ellipsis">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
    </div>
</div>

<!-- Webcam video snapshot -->
<canvas id="canvas" width="640" height="480"></canvas>


<script>
    'use strict';

    // General Configurations
    const SMS_ENABLED = false;
    const INTERVAL_ENABLED = true;
    const PROBABILITY_THRESHOLD = 60;
    const PREDICTION_URL = 'https://westeurope.api.cognitive.microsoft.com/customvision/v3.0/Prediction/f7e429ee-9764-4ae9-961a-05110112018f/classify/iterations/Iteration38/image';
    const PREDICTION_KEY = 'afb0613b7b4f4500b6b1b0e1a40b4a60';

    let restaurants = ["gute", "la salata", "labriut", "mitzle", "oshi oshi", "piano piano", "raksalat", "truman", "zozobra"];

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const flash = document.getElementById('flash');

    const constraints = {
        audio: true,
        video: {
            width: 1280, height: 720
        }
    };

    // Access webcam
    async function init() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            handleSuccess(stream);
        } catch (e) {
            console.log(e);
        }
    }

    // Success
    function handleSuccess(stream) {
        window.stream = stream;
        video.srcObject = stream;
        console.log("start");
        // start taking picture every 5 seconds
        if (INTERVAL_ENABLED) {
            setInterval(() => {
                captureImageInterval(video);
            }, 5000);
        }
    }

    // Load init
    init();
    
    let lastVisibleSubjects = [];

    let images = {
            truman: "truman.png",
            ["la salata"]: "la salata.png",
            zozobra: "zozobra.png",
            labriut: "labriut.png",
            mitzle: "mitzle.png",
        };


    function captureImageInterval(video) {
        var context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, 640, 480);
        flash.style.opacity = 1;

        setTimeout(() => {
            flash.style.opacity = 0;
        }, 400);

        canvas.toBlob((blob) => {
            const url = PREDICTION_URL;
            const predictionKey = PREDICTION_KEY;
            fetch(url, {
                method: 'post',
                headers: {
                    'Prediction-Key': predictionKey,
                    'Content-Type': 'application/octet-stream'
                },
                body: blob
            }).then(res => res.json())
                .then(res => {
                    let currentlyVisibleSubjects = [];
                    // in case nothing major was found show the processing text.
                    if (res.predictions && res.predictions.length) {
                        res.predictions.forEach(prediction => {
                            if (prediction.probability * 100 >= PROBABILITY_THRESHOLD) {
                                if (SMS_ENABLED) {
                                    sendSms(prediction.tagName);
                                }
                                currentlyVisibleSubjects.push(prediction.tagName);
                            }
                        });
                        updateDomLogos(lastVisibleSubjects, currentlyVisibleSubjects);
                        lastVisibleSubjects = currentlyVisibleSubjects;
                    }
                    // if(Math.round(res.predictions[0].probability)){
                    //     if (SMS_ENABLED) {
                    //         sendSms(res.predictions[0].tagName);
                    //     }
                    //     console.log(images[res.predictions[0].tagName]);
                    //     document.getElementById("logo").src = images[res.predictions[0].tagName];
                    //     document.getElementById("loader").classList.add("disable");
                    //     console.log(document.getElementById("loader"));
                    // } else {
                    //     document.getElementById("logo").src = "";
                    //     document.getElementById("loader").classList.remove("disable");
                    //     document.getElementById("bag-title").innerText = "This ain't a bag mister";
                    // }
                });
        });
    }

    function updateDomLogos(previous, current) {
        const logoWrapper = document.getElementById('logos_wrapper');
        logoWrapper.innerHTML = '';
        if (current.length) {
            setLoaderVisibility(false);
            current.forEach(subject => {
                let element = document.createElement('img');
                element.src = images[subject];
                logoWrapper.appendChild(element);
            });
        }
        else {
            setLoaderVisibility(true);
        }
    }

    function setLoaderVisibility(visible) {
        const loader = document.getElementById("loader");
        if (visible) {
            loader.classList.remove("disable");
        }
        else {
            loader.classList.add("disable");
        }
    }
    
    let alreadySent = [];

    function sendSms(brand) {
        let phoneNumber;
        switch (brand) {
            case "truman":
                phoneNumber = "972548120818"; // OMRI
                break;
            case "zozobra":
                phoneNumber = "972502525800"; // RAZ
                break;
            case "labriut":
                phoneNumber = "972523982995"; // MAXIM
                break;
            case "la salata":
                phoneNumber = "972545486339"; // ANAT
                break;
        }

        let brandTranslations = {
            truman: "Truman",
            zozobra: "Zozobra",
            labriut: "Labriut",
            'la salata': "La Salata"
        };

        let brandName = brandTranslations[brand] || brand;
        let phoneNumberIndex = alreadySent.indexOf(phoneNumber);

        if (phoneNumberIndex === -1) {
            console.log('Sending message for', brandName);
            alreadySent.push(phoneNumber);
            const message = `Your order from ${brandName} had just arrived!`;
            const url =
                `https://10bissmshackathon.azurewebsites.net/api/HttpTrigger1?code=6tGjrvUOetrVD5UtyAFe/oCkRxEc6GrE0f/GbEDqyNyK3g4kGsACyQ==&phone=${phoneNumber}&text=${message}`;

            fetch(url)
                .then(res => {
                    console.log('SMS Response:', res);
                })
                .catch(e => console.log('SMS Error', e));
        }
    }

</script>
</body>
